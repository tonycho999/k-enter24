import gemini_api
import database
import naver_api
import re
from datetime import datetime

# PROMPT_VERSIONSëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€
# ì¹´í…Œê³ ë¦¬ 6ë‹¨ê³„ ì§ˆë¬¸ (ì›ë¬¸ ê·¸ëŒ€ë¡œ ìœ ì§€)
PROMPT_VERSIONS = {
    "K-Pop": [
        "ìµœê·¼ 24ì‹œê°„ ë‚´ ì–¸ê¸‰ëŸ‰ì´ ê°€ì¥ ì••ë„ì ì¸ K-pop ê°€ìˆ˜ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "í˜„ì¬ ì°¨íŠ¸ ì—­ì£¼í–‰ì´ë‚˜ ê¸‰ìƒìŠ¹ìœ¼ë¡œ í™”ì œì¸ K-pop ê°€ìˆ˜ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë¹„í•˜ì¸ë“œ ë‰´ìŠ¤ë‚˜ ë…ì  ì¸í„°ë·°ë¡œ í™”ì œì¸ K-pop ê°€ìˆ˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ê¸€ë¡œë²Œ íŒ¬ë¤ ë° SNS ë°˜ì‘ì´ í­ë°œì ì¸ K-pop ê°€ìˆ˜ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ì—…ê³„ ë‚´ ëœ¨ê±°ìš´ ë…¼ìŸì´ë‚˜ ë°˜ì „ ì´ìŠˆì˜ ì£¼ì¸ê³µì¸ K-pop ê°€ìˆ˜ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ì»´ë°± ì˜ˆê³ ë‚˜ ëŒ€í˜• í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•œ K-pop ê°€ìˆ˜ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜."
    ],
    "K-Drama": [
        "í™”ì œì„± 1ìœ„ ë“œë¼ë§ˆì˜ ì£¼ì—° ë°°ìš°ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë“œë¼ë§ˆ í•œ í¸ìœ¼ë¡œ ì¸ìƒì´ ë°”ë€ ë¼ì´ì§• ë°°ìš°ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ì´¬ì˜ í˜„ì¥ ë¹„í™”ë‚˜ ìºìŠ¤íŒ… ì†Œì‹ìœ¼ë¡œ í™”ì œì¸ ë°°ìš°ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œ ì“°ê¸° ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ê¸€ë¡œë²Œ OTT ì°¨íŠ¸ë¥¼ íœ©ì“´ ë“œë¼ë§ˆì˜ ë°°ìš°ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ê²°ë§ ë…¼ë€ì´ë‚˜ ì¸í„°ë·°ë¡œ í™”ì œì¸ ë°°ìš°ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ì°¨ê¸°ì‘ì´ ê¸°ëŒ€ë˜ëŠ” 'ë¯¿ë³´ë°°' ë°°ìš°ë¥¼ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜."
    ],
    "K-Movie": [
        "ë°•ìŠ¤ì˜¤í”¼ìŠ¤ 1ìœ„ ì˜í™”ì˜ í•µì‹¬ ë°°ìš°ë‚˜ ê°ë…ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë…ë¦½ì˜í™”ë‚˜ ì €ì˜ˆì‚° ì˜í™”ì—ì„œ ë°œêµ´ëœ ì²œì¬ ì˜í™”ì¸ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë…íŠ¹í•œ ì—°ì¶œì´ë‚˜ ì œì‘ ë¹„í™”ë¡œ í™”ì œì¸ ì˜í™”ì¸ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "í•´ì™¸ ì‹œìƒì‹ ìˆ˜ìƒì´ë‚˜ í•´ì™¸ ì§„ì¶œë¡œ í™”ì œì¸ ì˜í™”ì¸ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ì˜í™”ê³„ ì´ìŠˆë‚˜ ë…¼ìŸì˜ ì¤‘ì‹¬ì¸ ì˜í™”ì¸ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ëŒ€ì‘ ê°œë´‰ì„ ì•ë‘ê³  í™ë³´ ì¤‘ì¸ í•«í•œ ì˜í™”ì¸ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜."
    ],
    "K-Entertain": [
        "ì‹œì²­ë¥  1ìœ„ ì˜ˆëŠ¥ì˜ ë©”ì¸ ì¶œì—°ì§„ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ìœ íŠœë¸Œë‚˜ OTT ì˜ˆëŠ¥ì—ì„œ ì œ2ì˜ ì „ì„±ê¸°ë¥¼ ë§ì€ ì˜ˆëŠ¥ì¸ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ì¶œì—°ì§„ ê°„ì˜ ì¼€ë¯¸ë¡œ í™”ì œì¸ ì˜ˆëŠ¥ì¸ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "í•´ì™¸ íŒ¬ë¤ì´ ê°•ë ¥í•œ ê¸€ë¡œë²Œ ì˜ˆëŠ¥ì¸ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "íƒœë„ ë…¼ë€ì´ë‚˜ ì„­ì™¸ ì´ìŠˆë¡œ í™”ì œì¸ ì˜ˆëŠ¥ì¸ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ìƒˆ ì‹œì¦Œ ë³µê·€ë‚˜ ì»´ë°±ìœ¼ë¡œ í™”ì œì¸ ì˜ˆëŠ¥ì¸ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜."
    ],
    "K-Culture": [
        "ê°€ì¥ í•«í•œ ì „ì‹œë‚˜ íŒì—…ìŠ¤í† ì–´ë¥¼ ê¸°íší•œ ë¬¸í™”ì¸ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "MZì„¸ëŒ€ íŠ¸ë Œë“œë¥¼ ì„ ë„í•˜ëŠ” ì˜ˆìˆ ê°€ë‚˜ ì¸ë¬¼ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ì „í†µì„ í™í•˜ê²Œ ì¬í•´ì„í•œ ì¥ì¸ì´ë‚˜ ì¸ë¬¼ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "K-í‘¸ë“œë‚˜ í•œêµ­ ë¬¸í™”ë¥¼ ì„¸ê³„ì— ì•Œë¦° ì¸ë¬¼ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ê³µìµì  ë¬¸í™” í™œë™ì´ë‚˜ ì§€ì—­ ì‚´ë¦¬ê¸°ë¡œ í™”ì œì¸ ì¸ë¬¼ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ëœë“œë§ˆí¬ ê±´ë¦½ì´ë‚˜ ëŒ€í˜• ì¶•ì œë¥¼ ì´ë„ëŠ” ì¸ë¬¼ì„ ì„ ì •í•´ ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œë¥¼ ì“°ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜."
    ]
}

def parse_rankings(raw_rankings_text):
    if not raw_rankings_text: return []
    parsed = []
    lines = raw_rankings_text.replace('*', '').strip().split('\n')
    for i, line in enumerate(lines):
        if i >= 10: break
        try:
            line = re.sub(r'\[\d+\]', '', line).strip()
            title = re.sub(r'^\d+[\.\)\s-]*', '', line).strip()
            if title:
                parsed.append({
                    "rank": i + 1,
                    "title_en": title,
                    "title_kr": title,
                    "score": 100 - (i * 5)
                })
        except: continue
    return parsed

def run_category_process(category, run_count):
    print(f"\nğŸš€ [Debug Mode Active] {category} (Run #{run_count})")

    v_idx = run_count % 6
    task = PROMPT_VERSIONS[category][v_idx]

    final_prompt = f"""
    ì‹¤ì‹œê°„ ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒ ê³¼ì œë¥¼ ìˆ˜í–‰í•˜ë¼: {task}
    
    ê²°ê³¼ë¬¼ì€ ë°˜ë“œì‹œ ì•„ë˜ íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ë¶„í•˜ë¼.
    
    ##TARGET_KR## í•œêµ­ì–´ ì´ë¦„
    ##TARGET_EN## English Name
    ##HEADLINE## ì˜ë¬¸ ê¸°ì‚¬ ì œëª©
    ##CONTENT## ì˜ë¬¸ ê¸°ì‚¬ ë³¸ë¬¸
    ##RANKINGS##
    1. ìˆœìœ„ ë°ì´í„° 1
    ... 10ìœ„ê¹Œì§€
    """

    # gemini_api.ask_gemini_with_search ê°€ ì›ë¬¸ì„ í•¨ê»˜ ë°˜í™˜í•˜ë„ë¡ ìˆ˜ì •ë˜ì—ˆë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜,
    # í•´ë‹¹ í•¨ìˆ˜ì—ì„œ íŒŒì‹± ì‹¤íŒ¨ ì‹œ Noneì„ ì£¼ë©´ ë‚´ë¶€ì—ì„œ raw_textë¥¼ ë¡œê¹…í•´ì•¼ í•©ë‹ˆë‹¤.
    # ì—¬ê¸°ì„œëŠ” gemini_apië¥¼ ìˆ˜ì •í•˜ì—¬ 'raw_text'ê¹Œì§€ ë°›ì•„ì˜¤ëŠ” êµ¬ì¡°ë¡œ ì„¤ëª…ë“œë¦½ë‹ˆë‹¤.
    
    data, raw_text = gemini_api.ask_gemini_with_search_debug(final_prompt)

    if not data:
        print(f"âŒ {category} ì¶”ì¶œ ì‹¤íŒ¨! ì›ë¬¸ì„ DB 'error_logs'ì— ê¸°ë¡í•©ë‹ˆë‹¤.")
        # [í•µì‹¬] ì‹¤íŒ¨ ì›ì¸ ë¶„ì„ì„ ìœ„í•´ DBì— raw_text ì €ì¥
        error_data = {
            "category": category,
            "run_count": run_count,
            "raw_response": raw_text if raw_text else "NO RESPONSE FROM AI",
            "error_message": "Tag parsing failed or safety filter triggered"
        }
        database.save_error_log(error_data) # database.pyì— ì´ í•¨ìˆ˜ë¥¼ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
        return

    # --- ì´í•˜ ì„±ê³µ ì‹œ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    try:
        raw_rankings = data.get('raw_rankings', '')
        clean_rankings = parse_rankings(raw_rankings)
        if clean_rankings:
            database.save_rankings_to_db(clean_rankings)

        target_kr = data.get("target_kr", "K-Star").strip()
        target_en = data.get("target_en", "K-Star").strip()
        final_image = naver_api.get_target_image(target_kr)

        news_items = [{
            "category": category,
            "keyword": target_en,
            "title": data.get("headline"),
            "summary": data.get("content"),
            "image_url": final_image,
            "score": 100,
            "created_at": datetime.now().isoformat(),
            "likes": 0
        }]
        database.save_news_to_live(news_items)
        print(f"ğŸ‰ ì„±ê³µ: {target_en} ë‰´ìŠ¤ ë°œí–‰ ì™„ë£Œ.")
    except Exception as e:
        print(f"ğŸš¨ ì €ì¥ ê³¼ì • ì¤‘ ì˜¤ë¥˜: {e}")
        database.save_error_log({
            "category": category,
            "run_count": run_count,
            "raw_response": str(data),
            "error_message": f"Save Error: {str(e)}"
        })
