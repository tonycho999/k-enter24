import news_api
import database
import naver_api
import re
import json
from datetime import datetime

# âœ… ëª¨ë“  ì¹´í…Œê³ ë¦¬ë¥¼ "3ëª… ì„ ì •" ë° "ì‹¬ì¸µ ê¸°ì‚¬"ë¡œ ìµœì í™” ì™„ë£Œ
PROMPT_VERSIONS = {
    "K-Pop": [
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìµœê·¼ 24ì‹œê°„ ë‚´ í•œêµ­ ê¸°ì‚¬ì—ì„œ ì–¸ê¸‰ëŸ‰ì´ ê°€ì¥ ì••ë„ì ì¸ K-pop ê°€ìˆ˜(ê·¸ë£¹) 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìµœê·¼ í•œêµ­ ê¸°ì‚¬ì—ì„œ í˜„ì¬ ì°¨íŠ¸ ì—­ì£¼í–‰ì´ë‚˜ ê¸‰ìƒìŠ¹ìœ¼ë¡œ í™”ì œì¸ K-pop ê°€ìˆ˜ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìµœê·¼ ë¹„í•˜ì¸ë“œ ë‰´ìŠ¤ë‚˜ ë…ì  ì¸í„°ë·°ë¡œ í™”ì œì¸ K-pop ê°€ìˆ˜ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ê¸€ë¡œë²Œ íŒ¬ë¤ ë° SNS ë°˜ì‘ì´ í­ë°œì ì¸ K-pop ê°€ìˆ˜ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìµœê·¼ ì—…ê³„ ë‚´ ëœ¨ê±°ìš´ ë…¼ìŸì´ë‚˜ ë°˜ì „ ì´ìŠˆì˜ ì£¼ì¸ê³µì¸ K-pop ê°€ìˆ˜ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ì»´ë°± ì˜ˆê³ ë‚˜ ëŒ€í˜• í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•œ K-pop ê°€ìˆ˜ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  Top 10 ê³¡ ìˆœìœ„ë¥¼ ì•Œë ¤ì¤˜."
    ],
    "K-Drama": [
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìµœê·¼ 24ì‹œê°„ ë‚´ í•œêµ­ ê¸°ì‚¬ì—ì„œ í™”ì œì„± 1ìœ„ ë“œë¼ë§ˆì˜ ì£¼ì—° ë°°ìš° 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìµœê·¼ ë“œë¼ë§ˆ í•œ í¸ìœ¼ë¡œ ì¸ìƒì´ ë°”ë€ ë¼ì´ì§• ë°°ìš° 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ì´¬ì˜ í˜„ì¥ ë¹„í™”ë‚˜ ìºìŠ¤íŒ… ì†Œì‹ìœ¼ë¡œ í™”ì œì¸ ë°°ìš° 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ê¸€ë¡œë²Œ OTT ì°¨íŠ¸ë¥¼ íœ©ì“´ ë“œë¼ë§ˆì˜ í•µì‹¬ ë°°ìš° 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ê²°ë§ ë…¼ë€ì´ë‚˜ ì¸í„°ë·°ë¡œ í™”ì œì¸ ë“œë¼ë§ˆ ë°°ìš° 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ì°¨ê¸°ì‘ì´ ê¸°ëŒ€ë˜ëŠ” 'ë¯¿ê³  ë³´ëŠ”' ë°°ìš° 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë“œë¼ë§ˆ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜."
    ],
    "K-Movie": [
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìµœê·¼ ë°•ìŠ¤ì˜¤í”¼ìŠ¤ ìƒìœ„ê¶Œ ì˜í™”ì˜ í•µì‹¬ ë°°ìš°ë‚˜ ê°ë… 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ë…ë¦½ì˜í™”ë‚˜ ì €ì˜ˆì‚° ì˜í™”ì—ì„œ ë°œêµ´ëœ ì²œì¬ ì˜í™”ì¸ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ë…íŠ¹í•œ ì—°ì¶œì´ë‚˜ ì œì‘ ë¹„í™”ë¡œ í™”ì œì¸ ì˜í™”ì¸ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. í•´ì™¸ ì‹œìƒì‹ ìˆ˜ìƒì´ë‚˜ í•´ì™¸ ì§„ì¶œë¡œ í™”ì œì¸ ì˜í™”ì¸ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ì˜í™”ê³„ ì´ìŠˆë‚˜ ë…¼ìŸì˜ ì¤‘ì‹¬ì¸ ì˜í™”ì¸ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ëŒ€ì‘ ê°œë´‰ì„ ì•ë‘ê³  í™ë³´ ì¤‘ì¸ í•«í•œ ì˜í™”ì¸ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜í™” ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜."
    ],
    "K-Entertain": [
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìµœê·¼ ì‹œì²­ë¥  ìƒìœ„ê¶Œ ì˜ˆëŠ¥ì˜ ë©”ì¸ ì¶œì—°ì§„ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìœ íŠœë¸Œë‚˜ OTT ì˜ˆëŠ¥ì—ì„œ ì œ2ì˜ ì „ì„±ê¸°ë¥¼ ë§ì€ ì˜ˆëŠ¥ì¸ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ì¶œì—°ì§„ ê°„ì˜ ì¼€ë¯¸ë¡œ í™”ì œì¸ ì˜ˆëŠ¥ì¸ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. í•´ì™¸ íŒ¬ë¤ì´ ê°•ë ¥í•œ ê¸€ë¡œë²Œ ì˜ˆëŠ¥ì¸ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìµœê·¼ íƒœë„ ë…¼ë€ì´ë‚˜ ì„­ì™¸ ì´ìŠˆë¡œ í™”ì œì¸ ì˜ˆëŠ¥ì¸ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìƒˆ ì‹œì¦Œ ë³µê·€ë‚˜ ì»´ë°±ìœ¼ë¡œ í™”ì œì¸ ì˜ˆëŠ¥ì¸ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ì˜ˆëŠ¥ ìˆœìœ„ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜."
    ],
    "K-Culture": [
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ìµœê·¼ ê°€ì¥ í•«í•œ ì „ì‹œë‚˜ íŒì—…ìŠ¤í† ì–´ë¥¼ ê¸°íší•œ ë¬¸í™”ì¸ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. MZì„¸ëŒ€ íŠ¸ë Œë“œë¥¼ ì„ ë„í•˜ëŠ” ì˜ˆìˆ ê°€ë‚˜ ì¸ë¬¼ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ì „í†µì„ í™í•˜ê²Œ ì¬í•´ì„í•œ ì¥ì¸ì´ë‚˜ ì¸ë¬¼ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. K-í‘¸ë“œë‚˜ í•œêµ­ ë¬¸í™”ë¥¼ ì„¸ê³„ì— ì•Œë¦° ì¸ë¬¼ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ê³µìµì  ë¬¸í™” í™œë™ì´ë‚˜ ì§€ì—­ ì‚´ë¦¬ê¸°ë¡œ í™”ì œì¸ ì¸ë¬¼ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜.",
        "ë„ˆëŠ” 20ë…„ì°¨ ì—°ì˜ˆë¶€ ê¸°ìì•¼. ëŒ€í˜• ì¶•ì œë‚˜ ëœë“œë§ˆí¬ í”„ë¡œì íŠ¸ë¥¼ ì´ë„ëŠ” ì¸ë¬¼ 3ëª…ì„ ì„ ì •í•´ ê°ê° ì‹¬ì¸µ ê¸°ì‚¬ 1ê°œì”©ì„ ì˜ì–´ë¡œ ì¨ì¤˜. ê·¸ë¦¬ê³  ë¬¸í™” í•«í”½ 1~10ìœ„ë¥¼ ì•Œë ¤ì¤˜."
    ]
}

def parse_rankings(raw_rankings_text, category):
    if not raw_rankings_text: return []
    parsed = []
    lines = raw_rankings_text.replace('*', '').strip().split('\n')
    for i, line in enumerate(lines):
        if i >= 10: break
        try:
            line = re.sub(r'\[\d+\]', '', line).strip()
            title = re.sub(r'^\d+[\.\)\s-]*', '', line).strip()
            if title:
                parsed.append({
                    "category": category,
                    "rank": i + 1,
                    "title_en": title,
                    "title_kr": title,
                    "score": 100 - (i * 5),
                    "created_at": datetime.now().isoformat()
                })
        except: continue
    return parsed

def run_category_process(category, run_count):
    print(f"\nğŸš€ [Processing Start] {category} (Run #{run_count})")

    v_idx = run_count % 6
    task = PROMPT_VERSIONS[category][v_idx]

    # âœ… AIê°€ 3ê°œì˜ ê¸°ì‚¬ë¥¼ êµ¬ë¶„í•˜ì—¬ ì¶œë ¥í•˜ë„ë¡ ê°•ì œí•˜ëŠ” ê³ ë„í™”ëœ í”„ë¡¬í”„íŠ¸
    final_prompt = f"""
    ì‹¤ì‹œê°„ ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒ ê³¼ì œë¥¼ ìˆ˜í–‰í•˜ë¼: {task}
    
    ê²°ê³¼ë¬¼ì€ ë°˜ë“œì‹œ ì•„ë˜ êµ¬ì¡°ë¥¼ 3ë²ˆ ë°˜ë³µí•˜ì—¬ ì‘ì„±í•˜ë¼. (ë‹¤ë¥¸ ì„¤ëª…ì€ ì¼ì ˆ ê¸ˆì§€)
    
    ##ARTICLE_START##
    ##TARGET_KR## í•œêµ­ì–´ ì´ë¦„
    ##TARGET_EN## English Name
    ##HEADLINE## ì˜ë¬¸ ê¸°ì‚¬ ì œëª©
    ##CONTENT## ì˜ë¬¸ ê¸°ì‚¬ ë³¸ë¬¸ (100~300ì ë‚´ì™¸ë¡œ ìƒì„¸íˆ)
    ##ARTICLE_END##

    ##RANKINGS##
    1. ìˆœìœ„ ë°ì´í„° 1
    ... 10ìœ„ê¹Œì§€ ì‘ì„±
    """

    # 1. AI í˜¸ì¶œ (news_api.ask_news_aiê°€ íŒŒì‹±ëœ ë¦¬ìŠ¤íŠ¸ì™€ ì›ë¬¸ì„ ë°˜í™˜í•´ì•¼ í•¨)
    data_list, raw_text = news_api.ask_news_ai(final_prompt)

    # 2. Archive ê¸°ë¡ (ì›ë¬¸ ë³´ì¡´)
    try:
        archive_data = {
            "category": category,
            "query": task,
            "raw_result": raw_text,
            "run_count": run_count,
            "created_at": datetime.now().isoformat()
        }
        database.save_search_archive(archive_data)
        print(f"ğŸ“‚ [Archive] AI ê²€ìƒ‰ ì›ë¬¸ ì €ì¥ ì™„ë£Œ.")
    except Exception as e:
        print(f"âš ï¸ Archive ì €ì¥ ì‹¤íŒ¨: {e}")

    if not data_list:
        print(f"âŒ {category} ì¶”ì¶œ ì‹¤íŒ¨! ìœ íš¨í•œ ê¸°ì‚¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    # 3. ë­í‚¹ ë°ì´í„° ì²˜ë¦¬
    try:
        rankings_match = re.search(r"##RANKINGS##(.*)", raw_text, re.S)
        if rankings_match:
            clean_rankings = parse_rankings(rankings_match.group(1), category)
            database.save_rankings_to_db(clean_rankings)
    except:
        print(f"âš ï¸ ë­í‚¹ íŒŒì‹± ì˜¤ë¥˜ ë°œìƒ")

    # 4. ìˆ˜ì§‘ëœ 3ê°œì˜ ê¸°ì‚¬ë¥¼ ê°œë³„ì ìœ¼ë¡œ ì²˜ë¦¬ ë° ì €ì¥
    success_count = 0
    for article in data_list:
        try:
            target_kr = article.get("target_kr", "K-Star").strip()
            target_en = article.get("target_en", "K-Star").strip()
            
            # ì¤‘ë³µ ì²´í¬ (ìµœê·¼ 4ì‹œê°„ ë‚´ ë™ì¼ í‚¤ì›Œë“œ ë°œí–‰ ì—¬ë¶€ í™•ì¸)
            if database.is_keyword_used_recently(category, target_en):
                print(f"â­ï¸ '{target_en}'ì€(ëŠ”) ìµœê·¼ ë°œí–‰ë˜ì–´ ê±´ë„ˆëœë‹ˆë‹¤.")
                continue

            print(f"ğŸ“¸ '{target_kr}' ê´€ë ¨ ì´ë¯¸ì§€ ìˆ˜ì§‘ ì¤‘...")
            final_image = naver_api.get_target_image(target_kr)

            news_item = {
                "category": category,
                "keyword": target_en,
                "title": article.get("headline", "Breaking News"),
                "summary": article.get("content", ""),
                "image_url": final_image,
                "score": 100,
                "created_at": datetime.now().isoformat(),
                "likes": 0
            }
            
            database.save_news_to_live([news_item])
            success_count += 1
            
        except Exception as e:
            print(f"ğŸš¨ ê¸°ì‚¬ ì €ì¥ ì˜¤ë¥˜: {e}")

    print(f"ğŸ‰ ì„±ê³µ: [{category}] ì´ {success_count}ê°œì˜ ê¸°ì‚¬ ë°œí–‰ ì™„ë£Œ.")
